<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>iOS播放音视频的几种方法</title>

	<link rel="shortcut icon" href="/styles/images/favicon.jpg">
	<link rel="icon" href="/styles/images/favicon.jpg">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="canonical" href="/2017/05/03/iOS%E6%92%AD%E6%94%BE%E9%9F%B3%E8%A7%86%E9%A2%91%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E6%B3%95/">
	<link rel="alternate" type="application/rss+xml" title="LuckyCat's Blog" href="/feed.xml">
	
	<meta name="description" content="康志华;个人博客;学而不思则罔;思而不学则殆;生命不止;折腾不休">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?94be4b0f9fc5d94cc0d0415ea6761ae9";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <img src="/styles/images/logo.jpg">
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">大类分解</a>
        </li>
        <li>
          <a href="/tag">小类内聚</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <!-- <li>
          <a href="/donate/"><strong>打赏</strong></a>
        </li> -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">关于<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/LuckyCat7848/">Github</a></li>
            <li><a rel="nofollow" target="_blank" href="http://www.luckycathome.com/Resume/">关于作者</a></li>
            <li><a rel="nofollow" href="/books">我的书单</a></li>
            <li><a rel="nofollow" href="/reference">推荐博客</a></li>
            <!-- <li><a href="/feed.xml">RSS订阅</a></li> -->
            <li class="divider"></li>
            <li><a rel="nofollow" target="_blank" href="https://github.com/LuckyCat7848/LuckyCat7848.github.io">本项目</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>iOS播放音视频的几种方法</h1>
		    <p>Post on May 03, 2017 by <a href="/about">LuckyCat</a></p>
		-->
		    <h1>Everything is well !</h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#技术-ref">技术</a>	/
    	<a href="/tag/#Object-C-ref">Object-C</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>目录</h1>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2017">2017</a>
          <ul class="nav">
            <li><a href="#month_2017_May">May</a></li>
      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_March">March</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2016">2016</a>
            <ul class="nav">
              <li><a href="#month_2016_November">November</a></li>
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_September">September</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2015">2015</a>
            <ul class="nav">
              <li><a href="#month_2015_August">August</a></li>
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_July">July</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_June">June</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div> 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">iOS播放音视频的几种方法</h1>
              <!--
                <p class="post-meta">May 3, 2017</p>
              -->
              <div class="meta">Posted on <span class="postdate">May 03, 2017</span> By <a target="_blank" href="http://localhost:4000">LuckyCat</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">一、音频</a>    <ul>
      <li><a href="#system-sound-servicesaudiotoolbox" id="markdown-toc-system-sound-servicesaudiotoolbox">1.1 System Sound Services：短、本地。————AudioToolbox框架中</a></li>
      <li><a href="#avaudioplayeravfoundation" id="markdown-toc-avaudioplayeravfoundation">1.2 AVAudioPlayer：本地。——AVFoundation</a></li>
      <li><a href="#mpmusicplayercontrollermediaplayer" id="markdown-toc-mpmusicplayercontrollermediaplayer">MPMusicPlayerController：播放音乐库中的音乐。MediaPlayer框架</a></li>
      <li><a href="#avaudiorecorder" id="markdown-toc-avaudiorecorder">AVAudioRecorder：录音。</a></li>
      <li><a href="#audio-queue-servicesaudiotoolbox" id="markdown-toc-audio-queue-servicesaudiotoolbox">1.3 Audio Queue Services：网络。——AudioToolbox框架中的音频队列服务</a></li>
    </ul>
  </li>
  <li><a href="#section-1" id="markdown-toc-section-1">二、视频</a>    <ul>
      <li><a href="#mpmovieplayercontroller" id="markdown-toc-mpmovieplayercontroller">2.1 MPMoviePlayerController：本地、网络，不用自定义界面。</a></li>
      <li><a href="#mpmovieplayerviewcontroller" id="markdown-toc-mpmovieplayerviewcontroller">2.2 MPMoviePlayerViewController：本地、网络，不用自定义界面。</a></li>
      <li><a href="#avplayer" id="markdown-toc-avplayer">2.3 AVPlayer：本地、网络，自定义界面。</a></li>
    </ul>
  </li>
  <li><a href="#section-2" id="markdown-toc-section-2">三、参考学习</a></li>
</ul>

<hr />

<h1 id="section">一、音频</h1>

<h2 id="system-sound-servicesaudiotoolbox">1.1 System Sound Services：短、本地。————AudioToolbox框架中</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>   //1.获得系统声音ID
    SystemSoundID <span class="nv">soundID</span><span class="o">=</span>0;
    /<span class="k">**</span>
     <span class="k">*</span> inFileUrl:音频文件url
     <span class="k">*</span> outSystemSoundID:声音id（此函数会将音效文件加入到系统音频服务中并返回一个长整形ID）
     <span class="k">*</span>/
    AudioServicesCreateSystemSoundID<span class="o">((</span>__bridge CFURLRef<span class="o">)(</span>fileUrl<span class="o">)</span>, &amp;soundID<span class="o">)</span>;
    //如果需要在播放完之后执行某些操作，可以调用如下方法注册一个播放完成回调函数
    AudioServicesAddSystemSoundCompletion<span class="o">(</span>soundID, NULL, NULL, soundCompleteCallback, NULL<span class="o">)</span>;
    //2.播放音频
    AudioServicesPlaySystemSound<span class="o">(</span>soundID<span class="o">)</span>;//播放音效
//    AudioServicesPlayAlertSound<span class="o">(</span>soundID<span class="o">)</span>;//播放音效并震动
</code></pre>
</div>

<h2 id="avaudioplayeravfoundation">1.2 AVAudioPlayer：本地。——AVFoundation</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>1. 初始化AVAudioPlayer对象，此时通常指定本地文件路径。
2. 设置播放器属性，例如重复次数、音量大小等。
3. 调用play方法播放。
</code></pre>
</div>

<p>AVAudioPlayer一次只能播放一个音频文件，所有上一曲、下一曲其实可以通过创建多个播放器对象来完成。
播放进度的实现主要依靠一个定时器实时计算当前播放时长和音频总时长的比例。
可以通过 [_audioPlayer setCurrentTime:10];实现前进、后退功能。</p>

<p>1.设置后台运行模式：在plist文件中添加Required background modes，并且设置item 0=App plays audio or streams audio/video using AirPlay（其实可以直接通过Xcode在Project Targets-Capabilities-Background Modes中设置）</p>

<p><img src="/source/iOS播放音视频的几种方法/01.png" alt="" /></p>

<p>2.设置AVAudioSession的类型为AVAudioSessionCategoryPlayback并且调用setActive::方法启动会话。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    AVAudioSession <span class="k">*</span><span class="nv">audioSession</span><span class="o">=[</span>AVAudioSession sharedInstance];
    <span class="o">[</span>audioSession setCategory:AVAudioSessionCategoryPlayback error:nil];
    <span class="o">[</span>audioSession setActive:YES error:nil];
</code></pre>
</div>
<p>注意：是否遵循静音键表示在播放过程中如果用户通过硬件设置为静音是否能关闭声音。</p>

<p>拔出耳机暂停播放</p>

<p>3.为了能够让应用退到后台之后支持耳机控制，建议添加远程控制事件（这一步不是后台播放必须的）</p>

<div class="highlighter-rouge"><pre class="highlight"><code>-<span class="o">(</span>NSTimer <span class="k">*</span><span class="o">)</span>timer<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>!_timer<span class="o">)</span> <span class="o">{</span>
        <span class="nv">_timer</span><span class="o">=[</span>NSTimer scheduledTimerWithTimeInterval:0.5 target:self selector:@selector<span class="o">(</span>updateProgress<span class="o">)</span> userInfo:nil repeats:true];
    <span class="o">}</span>
    <span class="k">return </span>_timer;
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  创建播放器
 <span class="k">*</span>
 <span class="k">*</span>  @return 音频播放器
 <span class="k">*</span>/
-<span class="o">(</span>AVAudioPlayer <span class="k">*</span><span class="o">)</span>audioPlayer<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>!_audioPlayer<span class="o">)</span> <span class="o">{</span>
        NSString <span class="k">*</span><span class="nv">urlStr</span><span class="o">=[[</span>NSBundle mainBundle]pathForResource:kMusicFile ofType:nil];
        NSURL <span class="k">*</span><span class="nv">url</span><span class="o">=[</span>NSURL fileURLWithPath:urlStr];
        NSError <span class="k">*</span><span class="nv">error</span><span class="o">=</span>nil;
        //初始化播放器，注意这里的Url参数只能时文件路径，不支持HTTP Url
        <span class="nv">_audioPlayer</span><span class="o">=[[</span>AVAudioPlayer alloc]initWithContentsOfURL:url error:&amp;error];
        //设置播放器属性
        _audioPlayer.numberOfLoops<span class="o">=</span>0;//设置为0不循环
        _audioPlayer.delegate<span class="o">=</span>self;
        <span class="o">[</span>_audioPlayer prepareToPlay];//加载音频文件到缓存
        <span class="k">if</span><span class="o">(</span>error<span class="o">){</span>
            NSLog<span class="o">(</span>@<span class="s2">"初始化播放器过程发生错误,错误信息:%@"</span>,error.localizedDescription<span class="o">)</span>;
            <span class="k">return </span>nil;
        <span class="o">}</span>
        //设置后台播放模式
        AVAudioSession <span class="k">*</span><span class="nv">audioSession</span><span class="o">=[</span>AVAudioSession sharedInstance];
        <span class="o">[</span>audioSession setCategory:AVAudioSessionCategoryPlayback error:nil];
//        <span class="o">[</span>audioSession setCategory:AVAudioSessionCategoryPlayback withOptions:AVAudioSessionCategoryOptionAllowBluetooth error:nil];
        <span class="o">[</span>audioSession setActive:YES error:nil];
        //添加通知，拔出耳机后暂停播放
        <span class="o">[[</span>NSNotificationCenter defaultCenter] addObserver:self selector:@selector<span class="o">(</span>routeChange:<span class="o">)</span> name:AVAudioSessionRouteChangeNotification object:nil];
    <span class="o">}</span>
    <span class="k">return </span>_audioPlayer;
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  播放音频
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>play<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>![self.audioPlayer isPlaying]<span class="o">)</span> <span class="o">{</span>
        <span class="o">[</span>self.audioPlayer play];
        self.timer.fireDate<span class="o">=[</span>NSDate distantPast];//恢复定时器
    <span class="o">}</span>
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  暂停播放
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>pause<span class="o">{</span>
    <span class="k">if</span> <span class="o">([</span>self.audioPlayer isPlaying]<span class="o">)</span> <span class="o">{</span>
        <span class="o">[</span>self.audioPlayer pause];
        self.timer.fireDate<span class="o">=[</span>NSDate distantFuture];//暂停定时器，注意不能调用invalidate方法，此方法会取消，之后无法恢复
        
    <span class="o">}</span>
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  点击播放/暂停按钮
 <span class="k">*</span>
 <span class="k">*</span>  @param sender 播放/暂停按钮
 <span class="k">*</span>/
- <span class="o">(</span>IBAction<span class="o">)</span>playClick:<span class="o">(</span>UIButton <span class="k">*</span><span class="o">)</span>sender <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span>sender.tag<span class="o">){</span>
        sender.tag<span class="o">=</span>0;
        <span class="o">[</span>self pause];
    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        sender.tag<span class="o">=</span>1;
        <span class="o">[</span>self play];
    <span class="o">}</span>
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  更新播放进度
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>updateProgress<span class="o">{</span>
    float <span class="nv">progress</span><span class="o">=</span> self.audioPlayer.currentTime /self.audioPlayer.duration;
    <span class="o">[</span>self.playProgress setProgress:progress animated:true];
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  一旦输出改变则执行此方法
 <span class="k">*</span>
 <span class="k">*</span>  @param notification 输出改变通知对象
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>routeChange:<span class="o">(</span>NSNotification <span class="k">*</span><span class="o">)</span>notification<span class="o">{</span>
    NSDictionary <span class="k">*</span><span class="nv">dic</span><span class="o">=</span>notification.userInfo;
    int <span class="nv">changeReason</span><span class="o">=</span> <span class="o">[</span>dic[AVAudioSessionRouteChangeReasonKey] intValue];
    //等于AVAudioSessionRouteChangeReasonOldDeviceUnavailable表示旧输出不可用
    <span class="k">if</span> <span class="o">(</span><span class="nv">changeReason</span><span class="o">==</span>AVAudioSessionRouteChangeReasonOldDeviceUnavailable<span class="o">)</span> <span class="o">{</span>
        AVAudioSessionRouteDescription <span class="k">*</span><span class="nv">routeDescription</span><span class="o">=</span>dic[AVAudioSessionRouteChangePreviousRouteKey];
        AVAudioSessionPortDescription <span class="k">*</span><span class="nv">portDescription</span><span class="o">=</span> <span class="o">[</span>routeDescription.outputs firstObject];
        //原设备为耳机则暂停
        <span class="k">if</span> <span class="o">([</span>portDescription.portType isEqualToString:@<span class="s2">"Headphones"</span><span class="o">])</span> <span class="o">{</span>
            <span class="o">[</span>self pause];
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c">#pragma mark - 播放器代理方法</span>
-<span class="o">(</span>void<span class="o">)</span>audioPlayerDidFinishPlaying:<span class="o">(</span>AVAudioPlayer <span class="k">*</span><span class="o">)</span>player successfully:<span class="o">(</span>BOOL<span class="o">)</span>flag<span class="o">{</span>
    NSLog<span class="o">(</span>@<span class="s2">"音乐播放完成..."</span><span class="o">)</span>;
<span class="o">}</span>
</code></pre>
</div>

<h2 id="mpmusicplayercontrollermediaplayer">MPMusicPlayerController：播放音乐库中的音乐。MediaPlayer框架</h2>

<h2 id="avaudiorecorder">AVAudioRecorder：录音。</h2>

<h2 id="audio-queue-servicesaudiotoolbox">1.3 Audio Queue Services：网络。——AudioToolbox框架中的音频队列服务</h2>

<p>将音频读取到缓冲器中，一旦一个缓冲器填充满之后就放到缓冲队列中，然后继续填充其他缓冲器；当开始播放时，则从第一个缓冲器中读取音频进行播放；一旦播放完之后就会触发回调函数，开始播放下一个缓冲器中的音频，同时填充第一个缓冲器放；填充满之后再次放回到缓冲队列。下面是详细的流程：
目前有很多第三方优秀框架可以直接使用，例如AudioStreamer、FreeStreamer。</p>

<p>FreeStreamer的功能很强大，不仅仅是播放本地、网络音频那么简单，它还支持播放列表、检查包内容、RSS订阅、播放中断等很多强大的功能，甚至还包含了一个音频分析器。</p>

<h1 id="section-1">二、视频</h1>

<h2 id="mpmovieplayercontroller">2.1 MPMoviePlayerController：本地、网络，不用自定义界面。</h2>

<h2 id="mpmovieplayerviewcontroller">2.2 MPMoviePlayerViewController：本地、网络，不用自定义界面。</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>-<span class="o">(</span>MPMoviePlayerViewController <span class="k">*</span><span class="o">)</span>moviePlayerViewController<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>!_moviePlayerViewController<span class="o">)</span> <span class="o">{</span>
        NSURL <span class="k">*</span><span class="nv">url</span><span class="o">=[</span>self getNetworkUrl];
        <span class="nv">_moviePlayerViewController</span><span class="o">=[[</span>MPMoviePlayerViewController alloc]initWithContentURL:url];
        <span class="o">[</span>self addNotification];
    <span class="o">}</span>
    <span class="k">return </span>_moviePlayerViewController;
<span class="o">}</span>
<span class="c">#pragma mark - UI事件</span>
- <span class="o">(</span>IBAction<span class="o">)</span>playClick:<span class="o">(</span>UIButton <span class="k">*</span><span class="o">)</span>sender <span class="o">{</span>
    self.moviePlayerViewController<span class="o">=</span>nil;//保证每次点击都重新创建视频播放控制器视图，避免再次点击时由于不播放的问题
    //注意，在MPMoviePlayerViewController.h中对UIViewController扩展两个用于模态展示和关闭MPMoviePlayerViewController的方法，增加了一种下拉展示动画效果
    <span class="o">[</span>self presentMoviePlayerViewControllerAnimated:self.moviePlayerViewController];
<span class="o">}</span>

<span class="c">#pragma mark - 控制器通知</span>
/<span class="k">**</span>
 <span class="k">*</span>  添加通知监控媒体播放控制器状态
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>addNotification<span class="o">{</span>
    NSNotificationCenter <span class="k">*</span><span class="nv">notificationCenter</span><span class="o">=[</span>NSNotificationCenter defaultCenter];
    <span class="o">[</span>notificationCenter addObserver:self selector:@selector<span class="o">(</span>mediaPlayerPlaybackStateChange:<span class="o">)</span> name:MPMoviePlayerPlaybackStateDidChangeNotification object:self.moviePlayerViewController.moviePlayer];
    <span class="o">[</span>notificationCenter addObserver:self selector:@selector<span class="o">(</span>mediaPlayerPlaybackFinished:<span class="o">)</span> name:MPMoviePlayerPlaybackDidFinishNotification object:self.moviePlayerViewController.moviePlayer];
    
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  播放状态改变，注意播放完成时的状态是暂停
 <span class="k">*</span>
 <span class="k">*</span>  @param notification 通知对象
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>mediaPlayerPlaybackStateChange:<span class="o">(</span>NSNotification <span class="k">*</span><span class="o">)</span>notification<span class="o">{</span>
    switch <span class="o">(</span>self.moviePlayerViewController.moviePlayer.playbackState<span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> MPMoviePlaybackStatePlaying:
            NSLog<span class="o">(</span>@<span class="s2">"正在播放..."</span><span class="p">)</span>;
            <span class="nb">break</span>;
        <span class="k">case</span> MPMoviePlaybackStatePaused:
            NSLog<span class="o">(</span>@<span class="s2">"暂停播放."</span><span class="p">)</span>;
            <span class="nb">break</span>;
        <span class="k">case</span> MPMoviePlaybackStateStopped:
            NSLog<span class="o">(</span>@<span class="s2">"停止播放."</span><span class="p">)</span>;
            <span class="nb">break</span>;
        default:
            NSLog<span class="o">(</span>@<span class="s2">"播放状态:%li"</span>,self.moviePlayerViewController.moviePlayer.playbackState<span class="o">)</span>;
            <span class="nb">break</span>;
    <span class="o">}</span>
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  播放完成
 <span class="k">*</span>
 <span class="k">*</span>  @param notification 通知对象
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>mediaPlayerPlaybackFinished:<span class="o">(</span>NSNotification <span class="k">*</span><span class="o">)</span>notification<span class="o">{</span>
    NSLog<span class="o">(</span>@<span class="s2">"播放完成.%li"</span>,self.moviePlayerViewController.moviePlayer.playbackState<span class="o">)</span>;
<span class="o">}</span>

</code></pre>
</div>

<h2 id="avplayer">2.3 AVPlayer：本地、网络，自定义界面。</h2>

<p>AVAsset：主要用于获取多媒体信息，是一个抽象类，不能直接使用。</p>

<p>AVURLAsset：AVAsset的子类，可以根据一个URL路径创建一个包含媒体信息的AVURLAsset对象。
AVPlayerItem：一个媒体资源管理对象，管理者视频的一些基本信息和状态，一个AVPlayerItem对应着一个视频资源。</p>

<p>获得播放状态和加载状态有用的通知只有一个：播放完成通知AVPlayerItemDidPlayToEndTimeNotification。在播放视频时，特别是播放网络视频往往需要知道视频加载情况、缓冲情况、播放情况，这些信息可以通过KVO监控AVPlayerItem的status、loadedTimeRanges属性来获得。当AVPlayerItem的status属性为AVPlayerStatusReadyToPlay是说明正在播放，只有处于这个状态时才能获得视频时长等信息；当loadedTimeRanges的改变时（每缓冲一部分数据就会更新此属性）可以获得本次缓冲加载的视频范围（包含起始时间、本次加载时长），这样一来就可以实时获得缓冲情况。然后就是依靠AVPlayer的- (id)addPeriodicTimeObserverForInterval:(CMTime)interval queue:(dispatch_queue_t)queue usingBlock:(void (^)(CMTime time))block方法获得播放进度，这个方法会在设定的时间间隔内定时更新播放进度，通过time参数通知客户端。</p>

<p>AVPlayer却提供了- (void)replaceCurrentItemWithPlayerItem:(AVPlayerItem *)item方法用于在不同的视频之间切换（事实上在AVFoundation内部还有一个AVQueuePlayer专门处理播放列表切换）</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#pragma mark - 私有方法</span>
-<span class="o">(</span>void<span class="o">)</span>setupUI<span class="o">{</span>
    //创建播放器层
    AVPlayerLayer <span class="k">*</span><span class="nv">playerLayer</span><span class="o">=[</span>AVPlayerLayer playerLayerWithPlayer:self.player];
    playerLayer.frame<span class="o">=</span>self.container.frame;
    //playerLayer.videoGravity<span class="o">=</span>AVLayerVideoGravityResizeAspect;//视频填充模式
    <span class="o">[</span>self.container.layer addSublayer:playerLayer];
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  截取指定时间的视频缩略图
 <span class="k">*</span>
 <span class="k">*</span>  @param timeBySecond 时间点
 <span class="k">*</span>/

/<span class="k">**</span>
 <span class="k">*</span>  初始化播放器
 <span class="k">*</span>
 <span class="k">*</span>  @return 播放器对象
 <span class="k">*</span>/
-<span class="o">(</span>AVPlayer <span class="k">*</span><span class="o">)</span>player<span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>!_player<span class="o">)</span> <span class="o">{</span>
        AVPlayerItem <span class="k">*</span><span class="nv">playerItem</span><span class="o">=[</span>self getPlayItem:0];
        <span class="nv">_player</span><span class="o">=[</span>AVPlayer playerWithPlayerItem:playerItem];
        <span class="o">[</span>self addProgressObserver];
        <span class="o">[</span>self addObserverToPlayerItem:playerItem];
    <span class="o">}</span>
    <span class="k">return </span>_player;
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  根据视频索引取得AVPlayerItem对象
 <span class="k">*</span>
 <span class="k">*</span>  @param videoIndex 视频顺序索引
 <span class="k">*</span>
 <span class="k">*</span>  @return AVPlayerItem对象
 <span class="k">*</span>/
-<span class="o">(</span>AVPlayerItem <span class="k">*</span><span class="o">)</span>getPlayItem:<span class="o">(</span>int<span class="o">)</span>videoIndex<span class="o">{</span>
    NSString <span class="k">*</span><span class="nv">urlStr</span><span class="o">=[</span>NSString stringWithFormat:@<span class="s2">"http://192.168.1.161/%i.mp4"</span>,videoIndex];
    urlStr <span class="o">=[</span>urlStr stringByAddingPercentEscapesUsingEncoding:NSUTF8StringEncoding];
    NSURL <span class="k">*</span><span class="nv">url</span><span class="o">=[</span>NSURL URLWithString:urlStr];
    AVPlayerItem <span class="k">*</span><span class="nv">playerItem</span><span class="o">=[</span>AVPlayerItem playerItemWithURL:url];
    <span class="k">return </span>playerItem;
<span class="o">}</span>
<span class="c">#pragma mark - 通知</span>
/<span class="k">**</span>
 <span class="k">*</span>  添加播放器通知
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>addNotification<span class="o">{</span>
    //给AVPlayerItem添加播放完成通知
    <span class="o">[[</span>NSNotificationCenter defaultCenter] addObserver:self selector:@selector<span class="o">(</span>playbackFinished:<span class="o">)</span> name:AVPlayerItemDidPlayToEndTimeNotification object:self.player.currentItem];
<span class="o">}</span>

-<span class="o">(</span>void<span class="o">)</span>removeNotification<span class="o">{</span>
    <span class="o">[[</span>NSNotificationCenter defaultCenter] removeObserver:self];
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  播放完成通知
 <span class="k">*</span>
 <span class="k">*</span>  @param notification 通知对象
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>playbackFinished:<span class="o">(</span>NSNotification <span class="k">*</span><span class="o">)</span>notification<span class="o">{</span>
    NSLog<span class="o">(</span>@<span class="s2">"视频播放完成."</span><span class="o">)</span>;
<span class="o">}</span>

<span class="c">#pragma mark - 监控</span>
/<span class="k">**</span>
 <span class="k">*</span>  给播放器添加进度更新
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>addProgressObserver<span class="o">{</span>
    AVPlayerItem <span class="k">*</span><span class="nv">playerItem</span><span class="o">=</span>self.player.currentItem;
    UIProgressView <span class="k">*</span><span class="nv">progress</span><span class="o">=</span>self.progress;
    //这里设置每秒执行一次
    <span class="o">[</span>self.player addPeriodicTimeObserverForInterval:CMTimeMake<span class="o">(</span>1.0, 1.0<span class="o">)</span> queue:dispatch_get_main_queue<span class="o">()</span> usingBlock:^<span class="o">(</span>CMTime <span class="nb">time</span><span class="o">)</span> <span class="o">{</span>
        float <span class="nv">current</span><span class="o">=</span>CMTimeGetSeconds<span class="o">(</span><span class="nb">time</span><span class="o">)</span>;
        float <span class="nv">total</span><span class="o">=</span>CMTimeGetSeconds<span class="o">([</span>playerItem duration]<span class="o">)</span>;
        NSLog<span class="o">(</span>@<span class="s2">"当前已经播放%.2fs."</span>,current<span class="o">)</span>;
        <span class="k">if</span> <span class="o">(</span>current<span class="o">)</span> <span class="o">{</span>
            <span class="o">[</span>progress setProgress:<span class="o">(</span>current/total<span class="o">)</span> animated:YES];
        <span class="o">}</span>
    <span class="o">}]</span>;
<span class="o">}</span>

/<span class="k">**</span>
 <span class="k">*</span>  给AVPlayerItem添加监控
 <span class="k">*</span>
 <span class="k">*</span>  @param playerItem AVPlayerItem对象
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>addObserverToPlayerItem:<span class="o">(</span>AVPlayerItem <span class="k">*</span><span class="o">)</span>playerItem<span class="o">{</span>
    //监控状态属性，注意AVPlayer也有一个status属性，通过监控它的status也可以获得播放状态
    <span class="o">[</span>playerItem addObserver:self forKeyPath:@<span class="s2">"status"</span> options:NSKeyValueObservingOptionNew context:nil];
    //监控网络加载情况属性
    <span class="o">[</span>playerItem addObserver:self forKeyPath:@<span class="s2">"loadedTimeRanges"</span> options:NSKeyValueObservingOptionNew context:nil];
<span class="o">}</span>
-<span class="o">(</span>void<span class="o">)</span>removeObserverFromPlayerItem:<span class="o">(</span>AVPlayerItem <span class="k">*</span><span class="o">)</span>playerItem<span class="o">{</span>
    <span class="o">[</span>playerItem removeObserver:self forKeyPath:@<span class="s2">"status"</span><span class="o">]</span>;
    <span class="o">[</span>playerItem removeObserver:self forKeyPath:@<span class="s2">"loadedTimeRanges"</span><span class="o">]</span>;
<span class="o">}</span>
/<span class="k">**</span>
 <span class="k">*</span>  通过KVO监控播放器状态
 <span class="k">*</span>
 <span class="k">*</span>  @param keyPath 监控属性
 <span class="k">*</span>  @param object  监视器
 <span class="k">*</span>  @param change  状态改变
 <span class="k">*</span>  @param context 上下文
 <span class="k">*</span>/
-<span class="o">(</span>void<span class="o">)</span>observeValueForKeyPath:<span class="o">(</span>NSString <span class="k">*</span><span class="o">)</span>keyPath ofObject:<span class="o">(</span>id<span class="o">)</span>object change:<span class="o">(</span>NSDictionary <span class="k">*</span><span class="o">)</span>change context:<span class="o">(</span>void <span class="k">*</span><span class="o">)</span>context<span class="o">{</span>
    AVPlayerItem <span class="k">*</span><span class="nv">playerItem</span><span class="o">=</span>object;
    <span class="k">if</span> <span class="o">([</span>keyPath isEqualToString:@<span class="s2">"status"</span><span class="o">])</span> <span class="o">{</span>
        AVPlayerStatus <span class="nv">status</span><span class="o">=</span> <span class="o">[[</span>change objectForKey:@<span class="s2">"new"</span><span class="o">]</span> intValue];
        <span class="k">if</span><span class="o">(</span><span class="nv">status</span><span class="o">==</span>AVPlayerStatusReadyToPlay<span class="o">){</span>
            NSLog<span class="o">(</span>@<span class="s2">"正在播放...，视频总长度:%.2f"</span>,CMTimeGetSeconds<span class="o">(</span>playerItem.duration<span class="o">))</span>;
        <span class="o">}</span>
    <span class="o">}</span><span class="k">else if</span><span class="o">([</span>keyPath isEqualToString:@<span class="s2">"loadedTimeRanges"</span><span class="o">]){</span>
        NSArray <span class="k">*</span><span class="nv">array</span><span class="o">=</span>playerItem.loadedTimeRanges;
        CMTimeRange timeRange <span class="o">=</span> <span class="o">[</span>array.firstObject CMTimeRangeValue];//本次缓冲时间范围
        float startSeconds <span class="o">=</span> CMTimeGetSeconds<span class="o">(</span>timeRange.start<span class="o">)</span>;
        float durationSeconds <span class="o">=</span> CMTimeGetSeconds<span class="o">(</span>timeRange.duration<span class="o">)</span>;
        NSTimeInterval totalBuffer <span class="o">=</span> startSeconds + durationSeconds;//缓冲总长度
        NSLog<span class="o">(</span>@<span class="s2">"共缓冲：%.2f"</span>,totalBuffer<span class="o">)</span>;
//
    <span class="o">}</span>
<span class="o">}</span>

<span class="c">#pragma mark - UI事件</span>
/<span class="k">**</span>
 <span class="k">*</span>  点击播放/暂停按钮
 <span class="k">*</span>
 <span class="k">*</span>  @param sender 播放/暂停按钮
 <span class="k">*</span>/
- <span class="o">(</span>IBAction<span class="o">)</span>playClick:<span class="o">(</span>UIButton <span class="k">*</span><span class="o">)</span>sender <span class="o">{</span>
//    AVPlayerItemDidPlayToEndTimeNotification
    //AVPlayerItem <span class="k">*</span><span class="nv">playerItem</span><span class="o">=</span> self.player.currentItem;
    <span class="k">if</span><span class="o">(</span>self.player.rate<span class="o">==</span>0<span class="o">){</span> //说明时暂停
        <span class="o">[</span>sender setImage:[UIImage imageNamed:@<span class="s2">"player_pause"</span><span class="o">]</span> forState:UIControlStateNormal];
        <span class="o">[</span>self.player play];
    <span class="o">}</span><span class="k">else if</span><span class="o">(</span>self.player.rate<span class="o">==</span>1<span class="o">){</span>//正在播放
        <span class="o">[</span>self.player pause];
        <span class="o">[</span>sender setImage:[UIImage imageNamed:@<span class="s2">"player_play"</span><span class="o">]</span> forState:UIControlStateNormal];
    <span class="o">}</span>
<span class="o">}</span>


/<span class="k">**</span>
 <span class="k">*</span>  切换选集，这里使用按钮的tag代表视频名称
 <span class="k">*</span>
 <span class="k">*</span>  @param sender 点击按钮对象
 <span class="k">*</span>/
- <span class="o">(</span>IBAction<span class="o">)</span>navigationButtonClick:<span class="o">(</span>UIButton <span class="k">*</span><span class="o">)</span>sender <span class="o">{</span>
    <span class="o">[</span>self removeNotification];
    <span class="o">[</span>self removeObserverFromPlayerItem:self.player.currentItem];
    AVPlayerItem <span class="k">*</span><span class="nv">playerItem</span><span class="o">=[</span>self getPlayItem:sender.tag];
    <span class="o">[</span>self addObserverToPlayerItem:playerItem];
    //切换视频
    <span class="o">[</span>self.player replaceCurrentItemWithPlayerItem:playerItem];
    <span class="o">[</span>self addNotification];
<span class="o">}</span>
</code></pre>
</div>

<p>到目前为止无论是MPMoviePlayerController还是AVPlayer来播放视频都相当强大，但是它也存在着一些不可回避的问题，那就是支持的视频编码格式很有限：H.264、MPEG-4，扩展名（压缩格式）：.mp4、.mov、.m4v、.m2v、.3gp、.3g2等。但是无论是MPMoviePlayerController还是AVPlayer它们都支持绝大多数音频编码，所以大家如果纯粹是为了播放音乐的话也可以考虑使用这两个播放器。那么如何支持更多视频编码格式呢？目前来说主要还是依靠第三方框架，在iOS上常用的视频编码、解码框架有：VLC、ffmpeg。</p>

<h1 id="section-2">三、参考学习</h1>

<ul>
  <li>
    <p><a href="http://www.cnblogs.com/kenshincui/p/4186022.html">iOS开发系列–音频播放、录音、视频播放、拍照、视频录制</a></p>
  </li>
  <li>
    <p><a href="http://blog.sina.com.cn/s/blog_a843a8850101k0d5.html">iOS 播放音频的几种方法</a></p>
  </li>
</ul>

            </article>
        </div>
      </div>
      <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
            


  <div id="uyan_frame"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://v2.uyan.cc/code/uyan.js?uid=2119519';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>





 
          </div>
        </article>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2016-2017 <a href="http://www.luckycathome.com/Resume/"><code>LuckyCat</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme from <a href="https://github.com/luoyan35714/LessOrMore">LessOrMore</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/application.js"></script>
<script src="/styles/js/lessismore.js"></script>

  </body>
</html>
