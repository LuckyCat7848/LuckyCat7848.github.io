<!DOCTYPE html>
<html>

  <head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>GPUImageå­¦ä¹ æ€»ç»“</title>

	<link rel="shortcut icon" href="/styles/images/favicon.jpg">
	<link rel="icon" href="/styles/images/favicon.jpg">

	<link rel="stylesheet" href="/styles/css/index.css">
	<link rel="stylesheet" href="/styles/css/fontawesome/css/font-awesome.min.css">
	<link rel="canonical" href="/2017/03/18/GPUImage%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/">
	<link rel="alternate" type="application/rss+xml" title="LuckyCat's Blog" href="/feed.xml">
	
	<meta name="description" content="åº·å¿—å;ä¸ªäººåšå®¢;å­¦è€Œä¸æ€åˆ™ç½”;æ€è€Œä¸å­¦åˆ™æ®†;ç”Ÿå‘½ä¸æ­¢;æŠ˜è…¾ä¸ä¼‘">

	<script src="/styles/js/jquery.min.js"></script>
	<!--[if lt IE 9]>
    	<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  	<![endif]-->
  	<script>
		var _hmt = _hmt || [];
		(function() {
		  var hm = document.createElement("script");
		  hm.src = "//hm.baidu.com/hm.js?94be4b0f9fc5d94cc0d0415ea6761ae9";
		  var s = document.getElementsByTagName("script")[0]; 
		  s.parentNode.insertBefore(hm, s);
		})();
	</script>
  	<style type="text/css">
	  	.docs-content{
	  		margin-bottom: 10px;
	  	}
  	</style>
</head>

  <body class="index">

    <header class="navbar navbar-inverse navbar-fixed-top docs-nav" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">
        <img src="/styles/images/logo.jpg">
      </a>
    </div>
    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">    
        <li>
          <a href="/">Home</a>
        </li>
        <li>
          <a href="/categories/">å¤§ç±»åˆ†è§£</a>
        </li>
        <li>
          <a href="/tag">å°ç±»å†…èš</a>
        </li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <!-- <li>
          <a href="/donate/"><strong>æ‰“èµ</strong></a>
        </li> -->
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">å…³äº<b class="caret"></b></a>
          <ul class="dropdown-menu">
            <li><a rel="nofollow" target="_blank" href="https://github.com/LuckyCat7848/">Github</a></li>
            <li><a rel="nofollow" target="_blank" href="http://www.luckycathome.com/Resume/">å…³äºä½œè€…</a></li>
            <li><a rel="nofollow" href="/books">æˆ‘çš„ä¹¦å•</a></li>
            <li><a rel="nofollow" href="/reference">æ¨èåšå®¢</a></li>
            <!-- <li><a href="/feed.xml">RSSè®¢é˜…</a></li> -->
            <li class="divider"></li>
            <li><a rel="nofollow" target="_blank" href="https://github.com/LuckyCat7848/LuckyCat7848.github.io">æœ¬é¡¹ç›®</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>
</header>
    <div class="docs-header" id="content">
  <div class="container">
  	
  		<!--
		    <h1>GPUImageå­¦ä¹ æ€»ç»“</h1>
		    <p>Post on Mar 18, 2017 by <a href="/about">LuckyCat</a></p>
		-->
		    <h1>Everything is well !</h1>
    
  </div>
</div>
    
      
<div class="banner">
  <div class="container">
  	
    	<a href="/categories/#æŠ€æœ¯-ref">æŠ€æœ¯</a>	/
    	<a href="/tag/#Object-C-ref">Object-C</a>
    
  </div>
</div>

    

    <div class="container docs-container">
  <div class="row">
    <div class="col-md-3">
      <div class="sidebar hidden-print" role="complementary">
        <div id="navigation">
  <h1>ç›®å½•</h1>
  <ul class="nav sidenav">
<!--
    
      
      
      
      

      
        <li><a href="#year_2017">2017</a>
          <ul class="nav">
            <li><a href="#month_2017_March">March</a></li>
      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2017_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2016">2016</a>
            <ul class="nav">
              <li><a href="#month_2016_November">November</a></li>
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_September">September</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2016_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
        
            </ul>
          </li>
          <li><a href="#year_2015">2015</a>
            <ul class="nav">
              <li><a href="#month_2015_August">August</a></li>
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_July">July</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_June">June</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_February">February</a></li>
          
        
      
    
      
      
      
      

      

      
            
          
              <li><a href="#month_2015_January">January</a></li>
          
        
      
    
      
      
      
      

      

      
            </ul>
          </li>
      
    
-->
  </ul>
</div> 
      </div>
    </div>
    <div class="col-md-9" role="main">
      <div class="panel docs-content">
        <div class="wrapper">
            <header class="post-header">
              <h1 class="post-title">GPUImageå­¦ä¹ æ€»ç»“</h1>
              <!--
                <p class="post-meta">Mar 18, 2017</p>
              -->
              <div class="meta">Posted on <span class="postdate">Mar 18, 2017</span> By <a target="_blank" href="http://localhost:4000">LuckyCat</a></div>
              <br />
            </header>
            <article class="post-content">
              <ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">ä¸€ã€ä»‹ç»</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">äºŒã€å†…ç½®æ»¤é•œ</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">ä¸‰ã€åˆ†æ®µå½•åˆ¶</a></li>
  <li><a href="#gpuimage" id="markdown-toc-gpuimage">å››ã€ GPUImageå½•åˆ¶è§†é¢‘</a>    <ul>
      <li><a href="#section-3" id="markdown-toc-section-3">4.1 åŸºæœ¬è®¾ç½®</a></li>
      <li><a href="#section-4" id="markdown-toc-section-4">4.2 å¼€å§‹å½•åˆ¶</a></li>
      <li><a href="#section-5" id="markdown-toc-section-5">4.3 åœæ­¢å½•åˆ¶</a></li>
      <li><a href="#section-6" id="markdown-toc-section-6">4.4 è§†é¢‘æ‹¼æ¥</a></li>
    </ul>
  </li>
  <li><a href="#section-7" id="markdown-toc-section-7">äº”ã€è§†é¢‘åŠ æ»¤é•œåŠŸèƒ½</a>    <ul>
      <li><a href="#section-8" id="markdown-toc-section-8">5.1 å•ä¸ªæ»¤é•œ</a></li>
      <li><a href="#section-9" id="markdown-toc-section-9">5.2 ç»„åˆæ»¤é•œ</a></li>
      <li><a href="#section-10" id="markdown-toc-section-10">5.3 æ·»åŠ æ»¤é•œ</a></li>
    </ul>
  </li>
  <li><a href="#mv" id="markdown-toc-mv">å…­ã€è§†é¢‘åŠ MVåŠŸèƒ½</a></li>
  <li><a href="#section-11" id="markdown-toc-section-11">ä¸ƒã€å­¦ä¹ </a></li>
</ul>

<h1 id="section">ä¸€ã€ä»‹ç»</h1>
<p>GPUImageæ˜¯Brad Larsonåœ¨githubæ‰˜ç®¡çš„å¼€æºé¡¹ç›®ã€‚</p>

<p>GPUImageæ˜¯ä¸€ä¸ªåŸºäºGPUå›¾åƒå’Œè§†é¢‘å¤„ç†çš„å¼€æºiOSæ¡†æ¶ï¼Œæä¾›å„ç§å„æ ·çš„å›¾åƒå¤„ç†æ»¤é•œï¼Œå¹¶ä¸”æ”¯æŒç…§ç›¸æœºå’Œæ‘„åƒæœºçš„å®æ—¶æ»¤é•œï¼› åŸºäºGPUçš„å›¾åƒåŠ é€Ÿï¼Œå› æ­¤å¯ä»¥åŠ é€Ÿå¯¹å®æ—¶æ‘„åƒå¤´è§†é¢‘ã€ç”µå½±ä»¥åŠimageçš„æ»¤é•œå’Œå…¶å®ƒæ•ˆæœå¤„ç†ï¼Œå¹¶ä¸”èƒ½å¤Ÿè‡ªå®šä¹‰å›¾åƒæ»¤é•œã€‚å¦å¤–ï¼Œ GPUImageæ”¯æŒARCã€‚</p>

<p>ä½¿ç”¨GPUImageå¤„ç†å›¾ç‰‡æ¯”Core Imageæ›´ç®€å•ï¼Œåªéœ€è¦å°†è¿‡æ»¤å™¨èµ‹ç»™å›¾ç‰‡å¯¹è±¡å³å¯ï¼Œä¸ç”¨è€ƒè™‘contextæˆ–è€…è®¾å¤‡ç­‰å…¶ä»–é—®é¢˜ã€‚GPUImageæä¾›äº†é™¤é«˜æ–¯æ¨¡ç³Šå¤–çš„å…¶ä»–å‡ ç§ä¸åŒæ•ˆæœçš„æ¨¡ç³Šï¼Œè™½ç„¶Core Imageä¹Ÿæä¾›äº†å‡ ç§æ¨¡ç³Šæ•ˆæœï¼Œä½†ç›®å‰åœ¨iOSä¸Šèƒ½ç”¨çš„å°±åªæœ‰é«˜æ–¯æ¨¡ç³Šï¼Œè€ŒGPUImageå¯ç”¨çš„æœ‰FastBlur, GaussianBlur, GaussianSelectiveBlur å’Œ BoxBlurã€‚æ­¤å¤–ï¼Œä½œä¸ºå¼€æºæ¡†æ¶çš„GPUImageè¿˜æ”¯æŒè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ã€‚</p>

<h1 id="section-1">äºŒã€å†…ç½®æ»¤é•œ</h1>

<p>å…±125ä¸ªæ»¤é•œ, åˆ†ä¸ºå››ç±»ï¼š</p>

<p>Color adjustments: 31 filters, é¢œè‰²å¤„ç†ç›¸å…³</p>

<p>Image processing: 40 filters, å›¾åƒå¤„ç†ç›¸å…³.</p>

<p>Blending modes: 29 filters, æ··åˆæ¨¡å¼ç›¸å…³.</p>

<p>Visual effects: 25 filters, è§†è§‰æ•ˆæœç›¸å…³.</p>

<h1 id="section-2">ä¸‰ã€åˆ†æ®µå½•åˆ¶</h1>
<p>å‚è€ƒ<a href="http://www.tuicool.com/articles/FVnumu">AVFoundationå’ŒGPUImageåˆæ¢</a>ã€‚</p>

<p>åˆ†æ®µå½•åˆ¶ï¼Œæ¯æ¬¡å½•åˆ¶éƒ½è¦åˆ›å»ºä¸€ä¸ªmovieWriterï¼Œæ¯æ¬¡éƒ½ä¼šåœ¨é‡æ–°åˆ›å»ºmovieWriterå¹¶å°†å®ƒè®¾ç½®ä¸ºvideoCameraçš„ audioEncodingTarget æ—¶å€™ï¼Œç•Œé¢éƒ½ä¼šå¡é¡¿ä¸€ä¸‹ï¼Œè¿™æ˜¯å› ä¸ºvideoCameraé»˜è®¤æ˜¯ä¸å½•åˆ¶å£°éŸ³çš„ï¼Œè€Œæ¯æ¬¡åˆ›å»ºmovieWriterçš„æ—¶å€™éƒ½ç”¨åˆ°äº† movieWriter.hasAudioTrack = YESï¼Œè°ƒç”¨è¿™ä¸ªä¹‹åvideoCameraä¼šè‡ªåŠ¨å»æ·»åŠ å£°éŸ³è¾“å…¥æºï¼Œå‡†å¤‡ä¸€äº›æ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªè¿‡ç¨‹ä¼šå¯¼è‡´ç•Œé¢å¡é¡¿ä¸€ä¸‹ï¼Œä¸‹é¢è¿™å¥ä»£ç å¾ˆé‡è¦ï¼š</p>

<div class="highlighter-rouge"><pre class="highlight"><code>â€“ <span class="o">(</span>BOOL<span class="o">)</span>addAudioInputsAndOutputs;
</code></pre>
</div>

<p>videoCameraçš„å¤´æ–‡ä»¶çš„æ³¨é‡Šæ˜¯ï¼šå½•åˆ¶çš„æ—¶å€™æ·»åŠ å£°éŸ³ï¼Œæ·»åŠ è¾“å…¥æºå’Œè¾“å‡ºæºä¼šæš‚æ—¶ä¼šä½¿å½•åˆ¶æš‚æ—¶å¡ä½ï¼Œæ‰€ä»¥åœ¨è¦ä½¿ç”¨å£°éŸ³çš„æƒ…å†µä¸‹è¦<code class="highlighter-rouge">å…ˆ</code>è°ƒç”¨è¯¥æ–¹æ³•æ¥é˜²æ­¢å½•åˆ¶è¢«å¡ä½ã€‚</p>

<h1 id="gpuimage">å››ã€ GPUImageå½•åˆ¶è§†é¢‘</h1>
<p>è½¬è‡ª<a href="http://blog.sina.com.cn/s/blog_d0c0c80c0102xbo0.html">GPUImage å½•åˆ¶è§†é¢‘æ³¨æ„äº‹é¡¹</a>ï¼Œæ„Ÿè°¢<a href="http://blog.sina.com.cn/u/3502295052">æˆ‘çš„ä¸ªç¥å•Š</a>çš„åˆ†äº«ã€‚</p>

<h2 id="section-3">4.1 åŸºæœ¬è®¾ç½®</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>// åˆ›å»ºæ‘„åƒå¤´
self.videoCamera <span class="o">=</span> <span class="o">[[</span>GPUImageVideoCamera alloc] initWithSessionPreset:AVCaptureSessionPreset640x480 cameraPosition:AVCaptureDevicePositionBack];

self.videoCamera.outputImageOrientation <span class="o">=</span> UIInterfaceOrientationPortrait; // è¾“å‡ºå›¾åƒæ—‹è½¬æ–¹å¼
self.videoCamera.horizontallyMirrorFrontFacingCamera <span class="o">=</span> YES;

// åˆ›å»ºç•Œé¢æ˜¾ç¤ºæ‘„åƒå†…å®¹
self.gpuImageView <span class="o">=</span> <span class="o">[[</span>GPUImageView alloc] initWithFrame:frame];
self.gpuImageView.fillMode <span class="o">=</span> kGPUImageFillModePreserveAspectRatioAndFill; // æ˜¾ç¤ºæ¨¡å¼å……æ»¡æ•´ä¸ªè¾¹æ¡†
self.gpuImageView.clipsToBounds <span class="o">=</span> YES;
<span class="o">[</span>self.gpuImageView.layer setMasksToBounds:YES];

// æ»¤é•œ
self.filter <span class="o">=</span> <span class="o">[[</span>GPUImageBrightnessFilter alloc] init];
self.filter.brightness <span class="o">=</span> 0.1f;
</code></pre>
</div>

<h2 id="section-4">4.2 å¼€å§‹å½•åˆ¶</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>// è¯¥å¥å¯é˜²æ­¢å…è®¸å£°éŸ³é€šè¿‡çš„æƒ…å†µä¸‹ï¼Œé¿å…å½•åˆ¶ç¬¬ä¸€å¸§é»‘å±é—ªå±å¡é¡¿ç°è±¡ï¼ˆåˆ†æ®µå½•åˆ¶é‡Œæœ‰è¯¦è§£ï¼‰
<span class="o">[</span>_camera addAudioInputsAndOutputs];

// é…ç½®å½•åˆ¶å™¨
NSURL <span class="k">*</span> saveURL <span class="o">=</span> <span class="o">[</span>self fileURLForTempMovieByName:[NSString stringWithFormat:@<span class="s2">"%d"</span>, videoFileNum]]; // åˆ†æ®µå½•åˆ¶,videoFileNum:ç¬¬å‡ æ®µ
self.movieWriter <span class="o">=</span> <span class="o">[[</span>GPUImageMovieWriter alloc] initWithMovieURL:saveURL  size:CGSizeMake<span class="o">(</span>480.0f, 640.0f<span class="o">)]</span>;

self.movieWriter.assetWriter.movieFragmentInterval <span class="o">=</span> kCMTimeInvalid;
self.movieWriter.encodingLiveVideo <span class="o">=</span> YES; // å½±å“å…¶å®æ˜¯expectsMediaDataInRealTimeå±æ€§ï¼ŒYESæ—¶ç”¨äºè¾“å…¥æµæ˜¯å®æ—¶çš„,æ¯”å¦‚è¯´æ‘„åƒå¤´
self.movieWriter.hasAudioTrack <span class="o">=</span> YES; // å¼€å¯å£°éŸ³é‡‡é›†
self.movieWriter.shouldPassthroughAudio <span class="o">=</span> YES; // æ˜¯å¦ä½¿ç”¨æºéŸ³æº

<span class="o">[</span>self.filter addTarget:self.movieWriter]; // æ»¤é•œæ·»åŠ è‡³moviewrite
<span class="o">[</span>self.filter addTarget:self.gpuImageView]; // æ»¤é•œæ·»åŠ gpuimageview
self.videoCamera.audioEncodingTarget <span class="o">=</span> self.movieWriter; // éŸ³é¢‘æ¥æºæ˜¯æ–‡ä»¶

// å¼€å§‹å½•åˆ¶
<span class="o">[</span>self.videoCamera startCameraCapture];
<span class="o">[</span>self.movieWriter startRecording];
</code></pre>
</div>

<h2 id="section-5">4.3 åœæ­¢å½•åˆ¶</h2>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="o">[</span>self.filter removeTarget:self.movieWriter];
<span class="o">[</span>self.movieWriter finishRecording];
self.videoCamera.audioEncodingTarget <span class="o">=</span> nil;
</code></pre>
</div>

<h2 id="section-6">4.4 è§†é¢‘æ‹¼æ¥</h2>

<ul>
  <li>4.4.1 AVFoundationåŸºæœ¬çŸ¥è¯†ç‚¹</li>
</ul>

<p>AVAssetï¼šåª’ä½“ã€‚</p>

<p>AVAssetTrackï¼šåª’ä½“è½¨é“ã€‚</p>

<p>AVMutableComposition ï¼šåŒ…å«äº†ä¸€ä¸ªæˆ–å¤šä¸ªç»™å®šç±»å‹çš„åª’ä½“è½¨é“çš„å®¹å™¨ã€‚</p>

<p>AVMutableCompositionTrack ï¼šå·¥ç¨‹æ–‡ä»¶ä¸­çš„è½¨é“ï¼Œæœ‰éŸ³é¢‘è½¨ã€è§†é¢‘è½¨ç­‰ï¼Œé‡Œé¢å¯ä»¥æ’å…¥å„ç§å¯¹åº”çš„ç´ æã€‚</p>

<p>AVMutableVideoCompositionï¼šç”¨æ¥ç”Ÿæˆvideoçš„ç»„åˆæŒ‡ä»¤ï¼ŒåŒ…å«å¤šæ®µinstructionï¼Œå¯ä»¥å†³å®šæœ€ç»ˆè§†é¢‘çš„å°ºå¯¸ã€‚</p>

<p>AVMutableVideoCompositionInstructionï¼šå†³å®šä¸€ä¸ªtimeRangeå†…æ¯ä¸ªè½¨é“çš„çŠ¶æ€ï¼ŒåŒ…å«å¤šä¸ªlayerInstructionã€‚</p>

<p>AVMutableVideoCompositionLayerInstructionï¼šå†³å®šè§†é¢‘è½¨é“çš„æ•ˆæœ:æ¨¡ç³Šã€å˜å½¢ã€è£å‰ª,å¯åˆ›å»ºå‡ºè¿‡æ¸¡æ•ˆæœã€‚</p>

<ul>
  <li>4.4.2 åˆ†æ®µè§†é¢‘çš„æ‹¼æ¥</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#pragma mark -</span>
<span class="c">#pragma mark è§†é¢‘æ‹¼æ¥,è§†é¢‘å’ŒéŸ³é¢‘åˆæˆ å­˜å‚¨ä¸º:MergerMovie</span>
- <span class="o">(</span>void<span class="o">)</span>mergeAndSaveMovieWithFirstAsset:<span class="o">(</span>AVAsset <span class="k">*</span> <span class="o">)</span>firstAsset secondAsset:<span class="o">(</span>AVAsset <span class="k">*</span><span class="o">)</span>secondAsset <span class="o">{</span>
    
    static int mergerFileNum <span class="o">=</span> 1; // åˆæˆåçš„è§†é¢‘æ–‡ä»¶ä¸ªæ•°<span class="o">(</span>å› ä¸ºæ˜¯é€’å½’åˆæˆ,ä¸ä¾¿åˆ é™¤ä¸Šä¸€ä¸ª,æ‰€ä»¥æœ‰å¤šä¸ªæ–‡ä»¶<span class="o">)</span>
    
    <span class="k">if</span> <span class="o">(</span>firstAsset !<span class="o">=</span>nil <span class="o">&amp;&amp;</span> secondAsset!<span class="o">=</span>nil<span class="o">)</span> <span class="o">{</span>
        // 1.åˆ›å»ºç»„åˆmixComposition,ç”¨äºåˆæˆè§†é¢‘,å’Œå£°éŸ³<span class="o">(</span>è¦åˆ†åˆ«åˆ›å»ºç»„åˆè½¨é“<span class="o">)</span>
        AVMutableComposition <span class="k">*</span>mixComposition <span class="o">=</span> <span class="o">[[</span>AVMutableComposition alloc] init];
        // 2.åˆ›å»º1å’Œ2çš„è§†é¢‘è½¨é“ã€éŸ³é¢‘è½¨é“,éƒ½åŠ å…¥ç»„åˆä¸­mixComposition
        AVMutableCompositionTrack <span class="k">*</span>firstVideoTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeVideo
                                                                                 preferredTrackID:kCMPersistentTrackID_Invalid];
        <span class="o">[</span>firstVideoTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, firstAsset.duration<span class="o">)</span>
                                 ofTrack:[[firstAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0]
                                  atTime:kCMTimeZero
                                   error:nil];
        AVMutableCompositionTrack <span class="k">*</span>firstAudioTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeAudio
                                                                                 preferredTrackID:kCMPersistentTrackID_Invalid];
        <span class="o">[</span>firstAudioTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, firstAsset.duration<span class="o">)</span>
                                 ofTrack:[[firstAsset tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0]
                                  atTime:kCMTimeZero
                                   error:nil];
        
        
        AVMutableCompositionTrack <span class="k">*</span>secondVideoTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeVideo
                                                                                  preferredTrackID:kCMPersistentTrackID_Invalid];
        <span class="o">[</span>secondVideoTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, secondAsset.duration<span class="o">)</span>
                                  ofTrack:[[secondAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0]
                                   atTime:firstAsset.duration
                                    error:nil];
        AVMutableCompositionTrack <span class="k">*</span>secondAudioTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeAudio
                                                                                  preferredTrackID:kCMPersistentTrackID_Invalid];
        <span class="o">[</span>secondAudioTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, secondAsset.duration<span class="o">)</span>
                                  ofTrack:[[secondAsset tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0]
                                   atTime:firstAsset.duration
                                    error:nil];
        
        // 3.åˆ›å»ºAVMutableVideoCompositionInstruction:ä¸€ä¸ªæŒ‡ä»¤ï¼Œå†³å®šä¸€ä¸ªtimeRangeå†…æ¯ä¸ªè½¨é“çš„çŠ¶æ€ï¼ŒåŒ…å«å¤šä¸ªlayerInstruction
        AVMutableVideoCompositionInstruction <span class="k">*</span>mainInstruction <span class="o">=</span> <span class="o">[</span>AVMutableVideoCompositionInstruction videoCompositionInstruction];
        mainInstruction.timeRange <span class="o">=</span> CMTimeRangeMake<span class="o">(</span>kCMTimeZero, CMTimeAdd<span class="o">(</span>firstAsset.duration, secondAsset.duration<span class="o">))</span>;
        
        // 3-1.åˆ›å»ºç¬¬ä¸€ä¸ªAVMutableVideoCompositionLayerInstruction:å†³å®šè§†é¢‘è½¨é“çš„æ•ˆæœ:æ¨¡ç³Šã€å˜å½¢ã€è£å‰ª,å¯åˆ›å»ºå‡ºè¿‡æ¸¡æ•ˆæœ
        AVMutableVideoCompositionLayerInstruction <span class="k">*</span>firstlayerInstruction <span class="o">=</span> <span class="o">[</span>AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:firstVideoTrack];
        AVAssetTrack <span class="k">*</span>firstAssetTrack <span class="o">=</span> <span class="o">[[</span>firstAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
        UIImageOrientation firstAssetOrientation_  <span class="o">=</span> UIImageOrientationUp;
        BOOL isFirstAssetPortrait_  <span class="o">=</span> NO;
        CGAffineTransform firstTransform <span class="o">=</span> firstAssetTrack.preferredTransform;
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span> UIImageOrientationRight;
            isFirstAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span>  UIImageOrientationLeft;
            isFirstAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> 1.0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span>  UIImageOrientationUp;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> -1.0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span> UIImageOrientationDown;
        <span class="o">}</span>
        <span class="o">[</span>firstlayerInstruction setTransform:firstAsset.preferredTransform atTime:kCMTimeZero];
        <span class="o">[</span>firstlayerInstruction setOpacity:0.0 atTime:firstAsset.duration];
        
        // 3-2.åˆ›å»ºç¬¬äºŒä¸ªAVMutableVideoCompositionLayerInstruction
        AVMutableVideoCompositionLayerInstruction <span class="k">*</span>secondlayerInstruction <span class="o">=</span> <span class="o">[</span>AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:secondVideoTrack];
        AVAssetTrack <span class="k">*</span>secondAssetTrack <span class="o">=</span> <span class="o">[[</span>secondAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
        UIImageOrientation secondAssetOrientation_  <span class="o">=</span> UIImageOrientationUp;
        BOOL isSecondAssetPortrait_ <span class="o">=</span> NO;
        CGAffineTransform secondTransform <span class="o">=</span> secondAssetTrack.preferredTransform;
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            <span class="nv">secondAssetOrientation_</span><span class="o">=</span> UIImageOrientationRight;
            isSecondAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            secondAssetOrientation_ <span class="o">=</span>  UIImageOrientationLeft;
            isSecondAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> 1.0<span class="o">)</span> <span class="o">{</span>
            secondAssetOrientation_ <span class="o">=</span>  UIImageOrientationUp;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> -1.0<span class="o">)</span> <span class="o">{</span>
            secondAssetOrientation_ <span class="o">=</span> UIImageOrientationDown;
        <span class="o">}</span>
        <span class="o">[</span>secondlayerInstruction setTransform:secondAsset.preferredTransform atTime:firstAsset.duration];
        
        // AVMutableVideoComposition:ç”¨æ¥ç”Ÿæˆvideoçš„ç»„åˆæŒ‡ä»¤,åŒ…å«å¤šæ®µinstruction,å¯ä»¥å†³å®šæœ€ç»ˆè§†é¢‘çš„å°ºå¯¸
        // 3-3.AVMutableVideoCompositionæ·»åŠ instructions
        mainInstruction.layerInstructions <span class="o">=</span> <span class="o">[</span>NSArray arrayWithObjects:firstlayerInstruction, secondlayerInstruction,nil];
        AVMutableVideoComposition <span class="k">*</span>mainCompositionInst <span class="o">=</span> <span class="o">[</span>AVMutableVideoComposition videoComposition];
        mainCompositionInst.instructions <span class="o">=</span> <span class="o">[</span>NSArray arrayWithObject:mainInstruction];
        mainCompositionInst.frameDuration <span class="o">=</span> CMTimeMake<span class="o">(</span>1, 30<span class="o">)</span>;
        
        CGSize naturalSizeFirst, naturalSizeSecond;
        <span class="k">if</span><span class="o">(</span>isFirstAssetPortrait_<span class="o">){</span>
            naturalSizeFirst <span class="o">=</span> CGSizeMake<span class="o">(</span>firstAssetTrack.naturalSize.height, firstAssetTrack.naturalSize.width<span class="o">)</span>;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            naturalSizeFirst <span class="o">=</span> firstAssetTrack.naturalSize;
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span>isSecondAssetPortrait_<span class="o">){</span>
            naturalSizeSecond <span class="o">=</span> CGSizeMake<span class="o">(</span>secondAssetTrack.naturalSize.height, secondAssetTrack.naturalSize.width<span class="o">)</span>;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            naturalSizeSecond <span class="o">=</span> secondAssetTrack.naturalSize;
        <span class="o">}</span>
        
        float renderWidth, renderHeight;
        renderWidth <span class="o">=</span> naturalSizeFirst.width &gt; naturalSizeSecond.width ? naturalSizeFirst.width : naturalSizeSecond.width;
        renderHeight <span class="o">=</span> naturalSizeFirst.height &gt; naturalSizeSecond.height ? naturalSizeFirst.height : naturalSizeSecond.height;
        mainCompositionInst.renderSize <span class="o">=</span> CGSizeMake<span class="o">(</span>renderWidth, renderHeight<span class="o">)</span>;
        
        // 4.è·å–è·¯å¾„
        NSURL <span class="k">*</span>url <span class="o">=</span> <span class="o">[</span>self fileURLForTempMovieByName:[NSString stringWithFormat:@<span class="s2">"MergerMovie%d"</span>, mergerFileNum]];
        
        // 5.åˆ›å»ºAVAssetExportSession,ç”¨äºå¯¼å‡ºåˆæˆå¥½çš„è§†é¢‘
        AVAssetExportSession <span class="k">*</span>exporter <span class="o">=</span> <span class="o">[[</span>AVAssetExportSession alloc] initWithAsset:mixComposition
                                                                          presetName:AVAssetExportPresetHighestQuality];
        exporter.outputURL<span class="o">=</span>url;
        exporter.outputFileType <span class="o">=</span> AVFileTypeMPEG4;//AVFileTypeQuickTimeMovie;
        exporter.shouldOptimizeForNetworkUse <span class="o">=</span> YES;
        exporter.videoComposition <span class="o">=</span> mainCompositionInst;
        __weak __typeof<span class="o">(</span>self<span class="o">)</span>weakSelf <span class="o">=</span> self;
        <span class="o">[</span>exporter exportAsynchronouslyWithCompletionHandler:^<span class="o">{</span>
            dispatch_async<span class="o">(</span>dispatch_get_main_queue<span class="o">()</span>, ^<span class="o">{</span>
                mergerFileNum ++;
                <span class="k">if</span> <span class="o">(</span>mergerFileNum &lt; <span class="o">[</span>_videoArray count]<span class="o">)</span> <span class="o">{</span>
                    // å–åˆæˆå¥½çš„è§†é¢‘å’Œä¸‹ä¸€ä¸ª,é€’å½’è¿›è¡Œè§†é¢‘æ‹¼æ¥,æ‹¼æ¥åå’ŒéŸ³é¢‘åˆæˆ
                    AVAsset <span class="k">*</span> nextAsset <span class="o">=</span> <span class="o">[</span>AVAsset assetWithURL:[_videoArray objectAtIndex:mergerFileNum]];
                    AVAsset <span class="k">*</span> mergerVideo <span class="o">=</span> <span class="o">[</span>AVAsset assetWithURL:[weakSelf fileURLForTempMovieByName:[NSString stringWithFormat:@<span class="s2">"MergerMovie%d"</span>, mergerFileNum - 1]]];
                    <span class="o">[</span>weakSelf mergeAndSaveMovieWithFirstAsset:mergerVideo secondAsset:nextAsset];
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    // åˆæˆå®Œæˆ,å¯¼å‡º
                    mergerFileFinally <span class="o">=</span> <span class="o">[</span>NSString stringWithFormat:@<span class="s2">"MergerMovie%d"</span>, mergerFileNum - 1];
                    mergerFileNum <span class="o">=</span> 1;
                    <span class="o">[</span>weakSelf exportDidFinish:exporter];
                <span class="o">}</span>
            <span class="o">})</span>;
        <span class="o">}]</span>;
    <span class="o">}</span>
<span class="o">}</span>
- <span class="o">(</span>void<span class="o">)</span>exportDidFinish:<span class="o">(</span>AVAssetExportSession<span class="k">*</span><span class="o">)</span>session <span class="o">{</span>
    __weak __typeof<span class="o">(</span>self<span class="o">)</span>weakSelf <span class="o">=</span> self;
    dispatch_async<span class="o">(</span>dispatch_get_main_queue<span class="o">()</span>, ^<span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span>session.status <span class="o">==</span> AVAssetExportSessionStatusCompleted<span class="o">)</span> <span class="o">{</span>
            // è§†é¢‘æ‹¼æ¥æˆåŠŸ,å–å‡ºè§†é¢‘ä¸­çš„éŸ³é¢‘
            <span class="o">[</span>weakSelf getAudioSound];
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            UIAlertView <span class="k">*</span>alert <span class="o">=</span> <span class="o">[[</span>UIAlertView alloc] initWithTitle:@<span class="s2">"Video Saved"</span> message:[NSString stringWithFormat:@<span class="s2">"Saved To File Failed -- %d"</span>, session.status]
                                                           delegate:self cancelButtonTitle:@<span class="s2">"OK"</span> otherButtonTitles:nil];
            <span class="o">[</span>alert show];
        <span class="o">}</span>
    <span class="o">})</span>;
<span class="o">}</span>
</code></pre>
</div>

<ul>
  <li>4.4.3 ä»åˆæˆçš„è§†é¢‘å–å‡ºéŸ³é¢‘è½¨é“</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>// ä»åˆæˆå¥½çš„è§†é¢‘ä¸­è·å–éŸ³é¢‘
- <span class="o">(</span>void<span class="o">)</span>getAudioSound <span class="o">{</span>
    AVURLAsset <span class="k">*</span>videoAsset <span class="o">=</span> <span class="o">[</span>AVURLAsset URLAssetWithURL:[self fileURLForTempMovieByName:mergerFileFinally] options:nil];
    AVMutableComposition <span class="k">*</span>mixComposition <span class="o">=</span> <span class="o">[[</span>AVMutableComposition alloc] init];
    //åˆ›å»ºä¸€ä¸ªç»„åˆè½¨é“,ç±»å‹æ˜¯AVMediaTypeAudio
    AVMutableCompositionTrack <span class="k">*</span>audioTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeAudio
                                                                        preferredTrackID:kCMPersistentTrackID_Invalid];
    
    //è·å–videoAssetä¸­çš„éŸ³é¢‘è½¨é“,æ’å…¥ç»„åˆè½¨é“
    <span class="o">[</span>audioTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, videoAsset.duration<span class="o">)</span>
                        ofTrack:[[videoAsset tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0] atTime:kCMTimeZero error:nil];
    
    NSString <span class="k">*</span>outFilePath <span class="o">=</span> <span class="o">[[</span>self fileURLForTempSoundByName:@<span class="s2">"MergerSound"</span><span class="o">]</span> path];
    <span class="o">[</span>self exportAudioAsset:audioTrack.asset toFilePath:outFilePath];
<span class="o">}</span>
- <span class="o">(</span>BOOL<span class="o">)</span>exportAudioAsset:<span class="o">(</span>AVAsset <span class="k">*</span><span class="o">)</span>avAsset toFilePath:<span class="o">(</span>NSString <span class="k">*</span><span class="o">)</span>filePath <span class="o">{</span>
    AVAssetExportSession <span class="k">*</span>exportSession <span class="o">=</span> <span class="o">[</span>AVAssetExportSession
                                           exportSessionWithAsset:avAsset
                                           presetName:AVAssetExportPresetAppleM4A];
    <span class="k">if</span> <span class="o">(</span>nil <span class="o">==</span> exportSession<span class="o">)</span> <span class="k">return </span>NO;//åˆ›å»ºå¤±è´¥ï¼Œåˆ™è·³å‡º
    
    exportSession.outputURL <span class="o">=</span> <span class="o">[</span>NSURL fileURLWithPath:filePath]; // output path æ–°æ–‡ä»¶è·¯å¾„
    exportSession.outputFileType <span class="o">=</span> AVFileTypeAppleM4A; // output file <span class="nb">type </span>æ–°æ–‡ä»¶ç±»å‹
    
    __weak __typeof<span class="o">(</span>self<span class="o">)</span>weakSelf <span class="o">=</span> self;
    <span class="o">[</span>exportSession exportAsynchronouslyWithCompletionHandler:^<span class="o">{</span> //block
        <span class="k">if</span> <span class="o">(</span>exportSession.status <span class="o">==</span> AVAssetExportSessionStatusCompleted<span class="o">)</span> <span class="o">{</span>
            dispatch_async<span class="o">(</span>dispatch_get_main_queue<span class="o">()</span>, ^<span class="o">{</span>
                // 1.æ ¹æ® Main.storyboard çš„å‰ç¼€ <span class="s2">"Main"</span> å–åˆ°storyBoard çš„åœ°å€
                UIStoryboard <span class="k">*</span>storyBoard <span class="o">=</span> <span class="o">[</span>UIStoryboard storyboardWithName:@<span class="s2">"Recording"</span> bundle:[NSBundle mainBundle]];
                // 2.æ ¹æ®äº‹å…ˆåœ¨storyBoardä¸­è®¾ç½®çš„ storyBoard ID æ¥è·å–ç›¸åº”çš„ ViewController
                VideoPlayViewController <span class="k">*</span> videoPlay <span class="o">=</span> <span class="o">[</span>storyBoard instantiateViewControllerWithIdentifier:@<span class="s2">"VideoPlayViewController"</span><span class="o">]</span>;
                videoPlay.playUrl <span class="o">=</span> <span class="o">[</span>weakSelf fileURLForTempMovieByName:mergerFileFinally];
                videoPlay.playSoundUrl <span class="o">=</span> <span class="o">[</span>weakSelf fileURLForTempSoundByName:@<span class="s2">"MergerSound"</span><span class="o">]</span>;
                <span class="o">[</span>weakSelf.navigationController pushViewController:videoPlay animated:YES];
            <span class="o">})</span>;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            dispatch_async<span class="o">(</span>dispatch_get_main_queue<span class="o">()</span>, ^<span class="o">{</span>
                UIAlertView <span class="k">*</span>alert <span class="o">=</span> <span class="o">[[</span>UIAlertView alloc] initWithTitle:@<span class="s2">"Audio Saved"</span> message:@<span class="s2">"Saved To File Failed"</span>
                                                               delegate:self cancelButtonTitle:@<span class="s2">"OK"</span> otherButtonTitles:nil];
                <span class="o">[</span>alert show];
            <span class="o">})</span>;
        <span class="o">}</span>
    <span class="o">}]</span>;
    <span class="k">return </span>YES;
<span class="o">}</span>
</code></pre>
</div>

<ul>
  <li>4.4.4 è°ƒç”¨åˆæˆè§†é¢‘æ–¹æ³•ï¼š</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code>// å–ç¬¬1,2æ®µ,è¿›è¡Œè§†é¢‘æ‹¼æ¥,æ‹¼æ¥åå–å‡ºå®Œæ•´éŸ³é¢‘,ä¼ ç•Œé¢
AVAsset <span class="k">*</span>firstAsset <span class="o">=</span> <span class="o">[</span>AVAsset assetWithURL:_videoArray[0]];
AVAsset <span class="k">*</span>secondAsset <span class="o">=</span> <span class="o">[</span>AVAsset assetWithURL:_videoArray[1]];
<span class="o">[</span>self mergeAndSaveMovieWithFirstAsset:firstAsset secondAsset:secondAsset];
</code></pre>
</div>

<h1 id="section-7">äº”ã€è§†é¢‘åŠ æ»¤é•œåŠŸèƒ½</h1>

<h2 id="section-8">5.1 å•ä¸ªæ»¤é•œ</h2>

<div class="highlighter-rouge"><pre class="highlight"><code>// ç´ ææ»¤é•œ
GPUImageBrightnessFilter <span class="k">*</span>newFilter <span class="o">=</span> <span class="o">[[</span>GPUImageBrightnessFilter alloc] init];
newFilter.brightness <span class="o">=</span> 0.4f;
self.filter <span class="o">=</span> newFilter;
</code></pre>
</div>

<h2 id="section-9">5.2 ç»„åˆæ»¤é•œ</h2>
<div class="highlighter-rouge"><pre class="highlight"><code>GPUImageRGBFilter <span class="k">*</span>filter1         <span class="o">=</span> <span class="o">[[</span>GPUImageRGBFilter alloc] init];
GPUImageToonFilter <span class="k">*</span>filter2        <span class="o">=</span> <span class="o">[[</span>GPUImageToonFilter alloc] init];
GPUImageColorInvertFilter <span class="k">*</span>filter3 <span class="o">=</span> <span class="o">[[</span>GPUImageColorInvertFilter alloc] init];
GPUImageSepiaFilter       <span class="k">*</span>filter4 <span class="o">=</span> <span class="o">[[</span>GPUImageSepiaFilter alloc] init];
<span class="o">[(</span>GPUImageFilterGroup <span class="k">*</span><span class="o">)</span>_filter addFilter:filter1];
<span class="o">[(</span>GPUImageFilterGroup <span class="k">*</span><span class="o">)</span>_filter addFilter:filter2];
<span class="o">[(</span>GPUImageFilterGroup <span class="k">*</span><span class="o">)</span>_filter addFilter:filter3];
<span class="o">[(</span>GPUImageFilterGroup <span class="k">*</span><span class="o">)</span>_filter addFilter:filter4];

<span class="o">[</span>filter1 addTarget:filter2];
<span class="o">[</span>filter2 addTarget:filter3];
<span class="o">[</span>filter3 addTarget:filter4];
              
<span class="o">[(</span>GPUImageFilterGroup <span class="k">*</span><span class="o">)</span>_filter setInitialFilters:[NSArray arrayWithObject:filter1]];
<span class="o">[(</span>GPUImageFilterGroup <span class="k">*</span><span class="o">)</span>_filter setTerminalFilter:filter4];
</code></pre>
</div>

<h2 id="section-10">5.3 æ·»åŠ æ»¤é•œ</h2>
<div class="highlighter-rouge"><pre class="highlight"><code>// imageMovie
self.movieFile <span class="o">=</span> <span class="o">[[</span>GPUImageMovie alloc] initWithURL:_playUrl];
_movieFile.runBenchmark <span class="o">=</span> YES;
_movieFile.playAtActualSpeed <span class="o">=</span> NO;
// æ»¤é•œ
<span class="o">[</span>_movieFile addTarget:_filter];
// GPUImageView
GPUImageView <span class="k">*</span>filterView <span class="o">=</span> <span class="o">[[</span>GPUImageView alloc] init];
<span class="o">[</span>_filter addTarget:filterView];
     
// MovieWriter
self.movieWriter <span class="o">=</span> <span class="o">[[</span>GPUImageMovieWriter alloc] initWithMovieURL:_currentMovieUrl size:CGSizeMake<span class="o">(</span>480.0, 640.0<span class="o">)]</span>;
<span class="o">[</span>_filter addTarget:_movieWriter];
        
_movieWriter.shouldPassthroughAudio <span class="o">=</span> YES;
_movieFile.audioEncodingTarget <span class="o">=</span> _movieWriter;
<span class="o">[</span>_movieFile enableSynchronizedEncodingUsingMovieWriter:_movieWriter];

// å¼€å§‹å¤„ç†
<span class="o">[</span>_movieWriter startRecording];
<span class="o">[</span>_movieFile startProcessing];

<span class="o">[</span>self.player pause];
 _processing.hidden <span class="o">=</span> NO;
 <span class="o">[</span>_movieWriter setCompletionBlock:^<span class="o">{</span>
	 <span class="o">[</span>_filter removeTarget:_movieWriter];
	 <span class="o">[</span>_movieWriter finishRecording];
	 dispatch_async<span class="o">(</span>dispatch_get_main_queue<span class="o">()</span>, ^<span class="o">{</span>
		 _processing.hidden <span class="o">=</span> YES;
     <span class="o">})</span>;
<span class="o">}]</span>;
</code></pre>
</div>

<h1 id="mv">å…­ã€è§†é¢‘åŠ MVåŠŸèƒ½</h1>
<ul>
  <li>ä»£ç æœ‰ç‚¹ä¹±ï¼Œç´¯äº†ï¼Œä¸æƒ³æ•´ç†äº†ï¼Œå¤§å¤šåŒç†å§ã€‚</li>
</ul>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">#pragma mark -</span>
<span class="c">#pragma mark - ğŸmvå¤„ç† 1314</span>
// åŠ mvå¤„ç†
- <span class="o">(</span>void<span class="o">)</span>processMovieByMVUrl:<span class="o">(</span>NSURL <span class="k">*</span><span class="o">)</span>mvUrl <span class="o">{</span>

    AVURLAsset <span class="k">*</span>firstAsset <span class="o">=</span> <span class="o">[</span>AVURLAsset URLAssetWithURL:_playUrl options:nil];
    AVURLAsset <span class="k">*</span>secondAsset <span class="o">=</span> <span class="o">[</span>AVURLAsset URLAssetWithURL:mvUrl options:nil];
 
    <span class="k">if</span> <span class="o">(</span>firstAsset.duration.value !<span class="o">=</span> 0 <span class="o">&amp;&amp;</span> secondAsset.duration.value !<span class="o">=</span> 0<span class="o">)</span> <span class="o">{</span>
        // 1 - Create AVMutableComposition object. This object will hold your AVMutableCompositionTrack instances.
        AVMutableComposition <span class="k">*</span>mixComposition <span class="o">=</span> <span class="o">[[</span>AVMutableComposition alloc] init];
        // 2 - Create two video tracks
        AVMutableCompositionTrack <span class="k">*</span>firstTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeVideo
                                                                            preferredTrackID:kCMPersistentTrackID_Invalid];
        <span class="o">[</span>firstTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, firstAsset.duration<span class="o">)</span>
                            ofTrack:[[firstAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0]
                             atTime:kCMTimeZero
                              error:nil];
        AVMutableCompositionTrack <span class="k">*</span>secondTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeVideo
                                                                             preferredTrackID:kCMPersistentTrackID_Invalid];
        <span class="o">[</span>secondTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, firstAsset.duration<span class="o">)</span>
                             ofTrack:[[secondAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0]
                              atTime:kCMTimeZero // ğŸŒ²æ”¹
                               error:nil];
        
        // 2.1 - Create AVMutableVideoCompositionInstruction
        AVMutableVideoCompositionInstruction <span class="k">*</span>mainInstruction <span class="o">=</span> <span class="o">[</span>AVMutableVideoCompositionInstruction videoCompositionInstruction];
        mainInstruction.timeRange <span class="o">=</span> CMTimeRangeMake<span class="o">(</span>kCMTimeZero,
                                                    firstAsset.duration<span class="o">)</span>;
        
        // 2.2 - Create an AVMutableVideoCompositionLayerInstruction <span class="k">for </span>the first track
        AVMutableVideoCompositionLayerInstruction <span class="k">*</span>firstlayerInstruction <span class="o">=</span> <span class="o">[</span>AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:firstTrack];
        AVAssetTrack <span class="k">*</span>firstAssetTrack <span class="o">=</span> <span class="o">[[</span>firstAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];
        UIImageOrientation firstAssetOrientation_  <span class="o">=</span> UIImageOrientationUp;
        BOOL isFirstAssetPortrait_  <span class="o">=</span> NO;
        CGAffineTransform firstTransform <span class="o">=</span> firstAssetTrack.preferredTransform;
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span> UIImageOrientationRight;
            isFirstAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span>  UIImageOrientationLeft;
            isFirstAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> 1.0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span>  UIImageOrientationUp;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>firstTransform.a <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> firstTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> firstTransform.d <span class="o">==</span> -1.0<span class="o">)</span> <span class="o">{</span>
            firstAssetOrientation_ <span class="o">=</span> UIImageOrientationDown;
        <span class="o">}</span>
        <span class="o">[</span>firstlayerInstruction setTransform:firstAsset.preferredTransform atTime:kCMTimeZero];
       
        // 2.3 - Create an AVMutableVideoCompositionLayerInstruction <span class="k">for </span>the second track
        AVMutableVideoCompositionLayerInstruction <span class="k">*</span>secondlayerInstruction <span class="o">=</span> <span class="o">[</span>AVMutableVideoCompositionLayerInstruction videoCompositionLayerInstructionWithAssetTrack:secondTrack];
        AVAssetTrack <span class="k">*</span>secondAssetTrack <span class="o">=</span> <span class="o">[[</span>secondAsset tracksWithMediaType:AVMediaTypeVideo] objectAtIndex:0];

        UIImageOrientation secondAssetOrientation_  <span class="o">=</span> UIImageOrientationUp;
        BOOL isSecondAssetPortrait_ <span class="o">=</span> NO;
        CGAffineTransform secondTransform <span class="o">=</span> secondAssetTrack.preferredTransform;
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            <span class="nv">secondAssetOrientation_</span><span class="o">=</span> UIImageOrientationRight;
            isSecondAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> 0<span class="o">)</span> <span class="o">{</span>
            secondAssetOrientation_ <span class="o">=</span>  UIImageOrientationLeft;
            isSecondAssetPortrait_ <span class="o">=</span> YES;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> 1.0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> 1.0<span class="o">)</span> <span class="o">{</span>
            secondAssetOrientation_ <span class="o">=</span>  UIImageOrientationUp;
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span>secondTransform.a <span class="o">==</span> -1.0 <span class="o">&amp;&amp;</span> secondTransform.b <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.c <span class="o">==</span> 0 <span class="o">&amp;&amp;</span> secondTransform.d <span class="o">==</span> -1.0<span class="o">)</span> <span class="o">{</span>
            secondAssetOrientation_ <span class="o">=</span> UIImageOrientationDown;
        <span class="o">}</span>
//        <span class="o">[</span>secondlayerInstruction setTransform:secondAsset.preferredTransform atTime:firstAsset.duration];
        <span class="o">[</span>secondlayerInstruction setTransform:secondAsset.preferredTransform atTime:kCMTimeZero];
        
        // 2.4 - Add instructions
        mainInstruction.layerInstructions <span class="o">=</span> <span class="o">[</span>NSArray arrayWithObjects:firstlayerInstruction, secondlayerInstruction,nil];
        AVMutableVideoComposition <span class="k">*</span>mainCompositionInst <span class="o">=</span> <span class="o">[</span>AVMutableVideoComposition videoComposition];
        mainCompositionInst.instructions <span class="o">=</span> <span class="o">[</span>NSArray arrayWithObject:mainInstruction];
        mainCompositionInst.frameDuration <span class="o">=</span> CMTimeMake<span class="o">(</span>1, firstAsset.duration.value/firstAsset.duration.timescale<span class="o">)</span>;
        
        CGSize naturalSizeFirst, naturalSizeSecond;
        <span class="k">if</span><span class="o">(</span>isFirstAssetPortrait_<span class="o">){</span>
            naturalSizeFirst <span class="o">=</span> CGSizeMake<span class="o">(</span>firstAssetTrack.naturalSize.height, firstAssetTrack.naturalSize.width<span class="o">)</span>;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            naturalSizeFirst <span class="o">=</span> firstAssetTrack.naturalSize;
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span>isSecondAssetPortrait_<span class="o">){</span>
            naturalSizeSecond <span class="o">=</span> CGSizeMake<span class="o">(</span>secondAssetTrack.naturalSize.height, secondAssetTrack.naturalSize.width<span class="o">)</span>;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            naturalSizeSecond <span class="o">=</span> secondAssetTrack.naturalSize;
        <span class="o">}</span>
        
        float renderWidth, renderHeight;
        <span class="k">if</span><span class="o">(</span>naturalSizeFirst.width &gt; naturalSizeSecond.width<span class="o">)</span> <span class="o">{</span>
            renderWidth <span class="o">=</span> naturalSizeFirst.width;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            renderWidth <span class="o">=</span> naturalSizeSecond.width;
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span>naturalSizeFirst.height &gt; naturalSizeSecond.height<span class="o">)</span> <span class="o">{</span>
            renderHeight <span class="o">=</span> naturalSizeFirst.height;
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            renderHeight <span class="o">=</span> naturalSizeSecond.height;
        <span class="o">}</span>
//        <span class="o">[</span>secondAsset increaseSize:[NSValue valueWithCGSize:CGSizeMake<span class="o">(</span>480, 640<span class="o">)]]</span>;
        <span class="o">[</span>firstlayerInstruction setOpacity:0.5 atTime:kCMTimeZero]; //r34645ğŸ
//        <span class="o">[</span>secondlayerInstruction setOpacity:0.5 atTime:kCMTimeZero]; //r34645ğŸ
        
        // 480, 640
        CGFloat result <span class="o">=</span> renderWidth &lt; renderHeight ? renderWidth : renderHeight;
        mainCompositionInst.renderSize <span class="o">=</span> CGSizeMake<span class="o">(</span>result, result<span class="o">)</span>;

        // 3 - Audio track
        AVAsset <span class="k">*</span>audioAsset <span class="o">=</span> <span class="o">[</span>AVAsset assetWithURL:_currentSoundUrl];
        <span class="k">if</span> <span class="o">(</span>audioAsset!<span class="o">=</span>nil<span class="o">)</span> <span class="o">{</span>
            AVMutableCompositionTrack <span class="k">*</span>AudioTrack <span class="o">=</span> <span class="o">[</span>mixComposition addMutableTrackWithMediaType:AVMediaTypeAudio preferredTrackID:kCMPersistentTrackID_Invalid];
            <span class="o">[</span>AudioTrack insertTimeRange:CMTimeRangeMake<span class="o">(</span>kCMTimeZero, firstAsset.duration<span class="o">)</span> ofTrack:[[audioAsset tracksWithMediaType:AVMediaTypeAudio] objectAtIndex:0] atTime:kCMTimeZero error:nil];
        <span class="o">}</span>
        
        // 4 - Get path
        NSURL <span class="k">*</span>url <span class="o">=</span> <span class="o">[</span>self fileURLForFilterMovieByName:mvFile];
        <span class="o">[</span>self removeFile:url];
        mvFile ++;
        // 5 - Create exporter
        AVAssetExportSession <span class="k">*</span>exporter <span class="o">=</span> <span class="o">[[</span>AVAssetExportSession alloc] initWithAsset:mixComposition
                                                                          presetName:AVAssetExportPresetHighestQuality];
        exporter.outputURL<span class="o">=</span>url;
        exporter.outputFileType <span class="o">=</span> AVFileTypeQuickTimeMovie;
        exporter.shouldOptimizeForNetworkUse <span class="o">=</span> YES;
        exporter.videoComposition <span class="o">=</span> mainCompositionInst; // åŠ 
        <span class="o">[</span>exporter exportAsynchronouslyWithCompletionHandler:^<span class="o">{</span>
            dispatch_async<span class="o">(</span>dispatch_get_main_queue<span class="o">()</span>, ^<span class="o">{</span>
                <span class="o">[</span>self exportDidFinish:exporter];
            <span class="o">})</span>;
        <span class="o">}]</span>;
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<h1 id="section-11">ä¸ƒã€å­¦ä¹ </h1>
<ul>
  <li><a href="http://www.jianshu.com/p/722d65bac58d">GPUImageè¯¦ç»†è§£æï¼ˆå…­ï¼‰-ç”¨è§†é¢‘åšè§†é¢‘æ°´å°</a></li>
  <li><a href="http://blog.csdn.net/xiaolinyeyi/article/details/50878996">AVAssetã€AVMutableCompositionç³»åˆ—ç±»çš„ç†è§£åŠè§†é¢‘è£å‰ªç¤ºä¾‹
</a></li>
  <li><a href="http://blog.csdn.net/merrygoot/article/details/51804906">iOS GPUImageä¹‹GPUImageFilterGroupç»„åˆæ»¤é•œï¼ˆ5ï¼‰</a></li>
  <li><a href="http://www.tuicool.com/articles/FVnumu">AVFoundationå’ŒGPUImageåˆæ¢</a></li>
  <li><a href="http://blog.csdn.net/think_ma/article/details/43093331">GPUImage.hç®€å•è¯´æ˜</a></li>
</ul>


            </article>
        </div>
      </div>
      <div class="panel docs-content">
        <article class="post-content">
          <div class="wrapper">
            


  <div id="uyan_frame"></div>
<script type="text/javascript">
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://v2.uyan.cc/code/uyan.js?uid=2119519';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>





 
          </div>
        </article>
      </div>
    </div>
  </div>
</div>

    
    <footer class="footer" role="contentinfo">
	<div class="container">
		<p class="copyright">Copyright &copy; 2016-2017 <a href="http://www.luckycathome.com/Resume/"><code>LuckyCat</code></a>.</p>
		<p>Powered by <a href="http://jekyllrb.com">Jekyll</a>, theme from <a href="https://github.com/luoyan35714/LessOrMore">LessOrMore</a></p>
	</div>
</footer>

<script src="/styles/js/jquery.min.js"></script>
<script src="/styles/js/bootstrap.min.js"></script>
<script src="/styles/js/holder.min.js"></script>
<script src="/styles/js/application.js"></script>
<script src="/styles/js/lessismore.js"></script>

  </body>
</html>
